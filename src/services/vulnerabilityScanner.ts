export interface Vulnerability {
  id: string;
  type: 'xss' | 'injection' | 'secrets';
  severity: 'critique' | 'eleve' | 'moyen' | 'faible';
  line: number;
  description: string;
  codeSnippet: string;
  fix: string;
  explanation: string;
}

export interface VulnerabilityPattern {
  patterns: RegExp[];
  severity: 'critique' | 'eleve' | 'moyen' | 'faible';
  description: string;
  fix: string;
  explanation: string;
}

const vulnerabilityPatterns: Record<string, VulnerabilityPattern> = {
  xss: {
    patterns: [
      /innerHTML\s*=\s*.*(?:req\.|request\.|input|user|params|query|body)/gi,
      /outerHTML\s*=\s*.*(?:req\.|request\.|input|user|params|query|body)/gi,
      /insertAdjacentHTML\s*\([^)]*(?:req\.|request\.|input|user|params|query|body)/gi,
      /document\.write\s*\([^)]*(?:req\.|request\.|input|user|params|query|body)/gi,
      /\.html\(\s*(?:req\.|request\.|input|user|params|query|body)/gi
    ],
    severity: 'eleve',
    description: 'Vulnérabilité XSS - Injection de contenu HTML non sécurisé',
    fix: 'Utilisez textContent au lieu de innerHTML, ou échappez le contenu HTML',
    explanation: 'Les attaques XSS permettent aux attaquants d\'exécuter du JavaScript malveillant dans le navigateur des utilisateurs.'
  },
  injection: {
    patterns: [
      /eval\s*\(/gi,
      /new\s+Function\s*\(/gi,
      /setTimeout\s*\(\s*["'][^"']*\+/gi,
      /setInterval\s*\(\s*["'][^"']*\+/gi,
      /exec\s*\(/gi
    ],
    severity: 'critique',
    description: 'Vulnérabilité d\'injection de code - Exécution de code non sécurisé',
    fix: 'Évitez eval(), utilisez JSON.parse() pour les données JSON, ou des alternatives sécurisées',
    explanation: 'L\'injection de code permet aux attaquants d\'exécuter du code arbitraire sur votre système.'
  },
  secrets: {
    patterns: [
      /password\s*[=:]\s*["'][^"']{3,}["']/gi,
      /api[_-]?key\s*[=:]\s*["'][^"']{10,}["']/gi,
      /secret\s*[=:]\s*["'][^"']{6,}["']/gi,
      /token\s*[=:]\s*["'][^"']{10,}["']/gi,
      /private[_-]?key\s*[=:]\s*["'][^"']{20,}["']/gi,
      /database[_-]?url\s*[=:]\s*["'][^"']{10,}["']/gi
    ],
    severity: 'eleve',
    description: 'Secrets codés en dur - Informations sensibles exposées dans le code',
    fix: 'Utilisez des variables d\'environnement ou un gestionnaire de secrets',
    explanation: 'Les secrets codés en dur peuvent être découverts par les attaquants et compromettre votre système.'
  }
};

export function scanCode(code: string, filename: string = 'code.js'): Vulnerability[] {
  const vulnerabilities: Vulnerability[] = [];
  const lines = code.split('\n');

  Object.entries(vulnerabilityPatterns).forEach(([type, config]) => {
    config.patterns.forEach(pattern => {
      let match;
      while ((match = pattern.exec(code)) !== null) {
        const lineNumber = code.substring(0, match.index).split('\n').length;
        const lineContent = lines[lineNumber - 1]?.trim() || '';
        
        // Éviter les doublons sur la même ligne
        const existingVuln = vulnerabilities.find(v => 
          v.type === type && v.line === lineNumber
        );
        
        if (!existingVuln && lineContent) {
          vulnerabilities.push({
            id: `${type}-${lineNumber}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            type: type as 'xss' | 'injection' | 'secrets',
            severity: config.severity,
            line: lineNumber,
            description: config.description,
            codeSnippet: lineContent,
            fix: config.fix,
            explanation: config.explanation
          });
        }
      }
    });
  });

  return vulnerabilities.sort((a, b) => {
    const severityOrder = { critique: 0, eleve: 1, moyen: 2, faible: 3 };
    return severityOrder[a.severity] - severityOrder[b.severity];
  });
}

export const exampleVulnerableCode = `// Exemple de code avec vulnérabilités pour test
function handleUserInput() {
  const userInput = req.body.content;
  
  // Vulnérabilité XSS
  document.getElementById('output').innerHTML = userInput;
  
  // Vulnérabilité d'injection
  eval('console.log("' + userInput + '")');
  
  // Secret codé en dur
  const apiKey = "sk-1234567890abcdef";
  const password = "supersecret123";
  
  // Code sécurisé (exemple)
  document.getElementById('safe-output').textContent = userInput;
  
  // Autre vulnérabilité XSS
  element.outerHTML = req.query.html;
  
  // Injection via Function
  new Function('return ' + userInput)();
}

// Configuration de base de données non sécurisée
const dbConfig = {
  host: 'localhost',
  user: 'admin',
  password: 'admin123',
  database: 'myapp'
};`;